<ng-template #tooltipTemplate>
  <p class="text-primary">
    <a href="https://github.com/axonivy-market/market/wiki/Marketplace-Repositories-Security-Monitor-documentation" target="_blank">See more</a>
  </p>
</ng-template>

<div class="container">
  <!-- <div id="monitoring-info-container" class="d-flex justify-content-end align-items-center">
    <a href="https://github.com/axonivy-market/market/wiki/Marketplace-Repositories-Security-Monitor-documentation" target="_blank"><i class="bi bi-info-circle"></i></a>
  </div> -->
  <div class="header">
    <div class="d-flex align-items-center justify-content-center gap-2">
      <h2 [lang]="languageService.selectedLanguage()">
        {{ 'monitor.dashboard.title' | translate }}
      </h2>
      <!-- <button
        type="button"
        id="build-info-tooltip"
        placement="top"
        [ngbTooltip]="tooltipTemplate"
        tooltipClass="build-info-tooltip-custom-class">
        <span>
            <i class="bi bi-info-circle"></i>
        </span>
      </button> -->
      <a href="https://github.com/axonivy-market/market/wiki/Marketplace-Repositories-Security-Monitor-documentation" target="_blank"><i class="bi bi-info-circle"></i></a>
    </div>
    <h3 [lang]="languageService.selectedLanguage()">
      {{ 'monitor.dashboard.subtitle' | translate }}
    </h3>
  </div>
  @if (loading) {
    <div class="loading" [lang]="languageService.selectedLanguage()">
      {{ 'monitor.dashboard.loading' | translate }}
    </div>
  }

  @if (error) {
    <div class="error">{{ error }}</div>
  }

  @if (!loading && repositories.length) {
    <h4 class="section-title">{{ 'monitor.dashboard.focus.title' | translate }}</h4>
    <div class="repo-grid">
      <ng-container *ngFor="let repo of repositories; trackBy: trackByName">
        @if (repo.focused) {
          <ng-container *ngTemplateOutlet="repoCard; context: { $implicit: repo }"></ng-container>
        }
      </ng-container>
    </div>
  }

  @if (!loading && repositories.length) {
    <h4 class="section-title">{{ 'monitor.dashboard.standard.title' | translate }}</h4>
    <div class="repo-grid">
      <ng-container *ngFor="let repo of repositories; trackBy: trackByName">
        @if (!repo.focused) {
          <ng-container *ngTemplateOutlet="repoCard; context: { $implicit: repo }"></ng-container>
        }
      </ng-container>
    </div>
  }

  <ng-template #repoCard let-repo>
    <div class="repo-card">
      <div class="repo-header">
        <p>{{ repo.name }}</p>
        <span class="visibility">{{ repo.language }}</span>
      </div>
      
      <div class="repo-info">
        @if (repo.ciBadgeUrl) {
          <div class="badge-row">
            <span class="icon">üè∑Ô∏è</span>
            <img [src]="repo.ciBadgeUrl" alt="ci Badge for {{ repo.name }}" style="cursor: pointer" class="me-2" (click)="onBadgeClick(repo.name, 'ci')"/>
            <!-- <app-build-badge-tooltip [buildType]="ciBuild"/> -->
          </div>
          <div class="workflow">
            <p class="passed">‚úÖ {{ 'monitor.dashboard.passed' | translate }}: <b>{{ getTestCount(repo, 'CI', 'ALL', 'PASSED') }}</b></p>
            <p class="failed">‚ùå {{ 'monitor.dashboard.failed' | translate }}: <b>{{ getTestCount(repo, 'CI', 'ALL', 'FAILED') }}</b></p>
            <div class="sub-status">
              {{ 'monitor.dashboard.testCounts.mock' | translate }}
              {{ getTestCount(repo, 'CI', 'MOCK', 'PASSED') }}‚úÖ /
              {{ getTestCount(repo, 'CI', 'MOCK', 'FAILED') }}‚ùå |
              {{ 'monitor.dashboard.testCounts.real' | translate }}
              {{ getTestCount(repo, 'CI', 'REAL', 'PASSED') }}‚úÖ /
              {{ getTestCount(repo, 'CI', 'REAL', 'FAILED') }}‚ùå
            </div>
          </div>
        }
        @if (repo.devBadgeUrl) {
          <div class="badge-row">
            <span class="icon">üõ†Ô∏è</span>
            <img [src]="repo.devBadgeUrl" alt="dev Badge for {{ repo.name }}" style="cursor: pointer" class="me-2" (click)="onBadgeClick(repo.name, 'dev')"/>
            <!-- <app-build-badge-tooltip [buildType]="devBuild"/> -->
          </div>
          <div class="workflow">
            <p class="passed">‚úÖ {{ 'monitor.dashboard.passed' | translate }}: <b>{{ getTestCount(repo, 'DEV', 'ALL', 'PASSED') }}</b></p>
            <p class="failed">‚ùå {{ 'monitor.dashboard.failed' | translate }}: <b>{{ getTestCount(repo, 'DEV', 'ALL', 'FAILED') }}</b></p>
            <div class="sub-status">
              {{ 'monitor.dashboard.testCounts.mock' | translate }}
              {{ getTestCount(repo, 'DEV', 'MOCK', 'PASSED') }}‚úÖ /
              {{ getTestCount(repo, 'DEV', 'MOCK', 'FAILED') }}‚ùå|
              {{ 'monitor.dashboard.testCounts.real' | translate }}
              {{ getTestCount(repo, 'DEV', 'REAL', 'PASSED') }}‚úÖ /
              {{ getTestCount(repo, 'DEV', 'REAL', 'FAILED') }}‚ùå
            </div>
          </div>
        }
        <p>
          <span class="icon">üìÖ</span>
          {{ 'monitor.dashboard.lastUpdated' | translate }}:
          {{ repo.lastUpdated | date: 'medium' }}
        </p>
      </div>
    </div>
  </ng-template>
</div>